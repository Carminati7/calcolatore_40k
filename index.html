<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore 40k</title>
    <link rel="stylesheet" href="assets/style-common.css">
    <link rel="stylesheet" href="assets/style-index.css">
    <!-- Use absolute manifest URL so browsers fetch the correct manifest on GitHub Pages -->
    <link rel="manifest" href="/calcolatore_40k/manifest.webmanifest">
    <meta name="theme-color" content="#222222">
    <link rel="icon" type="image/x-ico" sizes="192x192" href="assets/img/favicon.ico">
</head>

<body>
    <header>
        <button class="nav-toggle" aria-expanded="false" aria-controls="main-nav">☰ Menu</button>
        <nav id="main-nav" class="main-nav">
            <a href="index.html" class="active">Calcolatore</a>
            <a href="docs.html">Documentazione</a>
            <a href="changelog.html">Diario di bordo</a>
        </nav>
        <h1>Calcolatore 40k</h1>
    </header>
    <main>
        <div class="card-3col">
            <section class="col col-unit">
                <h2>La tua unità</h2>
                <form id="calcolatore-form">
                    <div id="profili-container">
                        <div class="profilo" data-profilo-id="0">
                            <h3>Profilo 1</h3>
                            <button class="remove-profile" onclick="if(document.querySelectorAll('.profilo').length > 1) this.parentElement.remove(); else alert('Non puoi rimuovere l\'ultimo profilo!');">✖ Rimuovi</button>
                            <div class="form-group">
                                <label for="attacchi-0">Numero di attacchi</label>
                                <input type="number" id="attacchi-0" name="attacchi-0" min="1" max="999" required>
                            </div>
                            <div class="form-group">
                                <label for="balistic-0">Balistic skill (es: 3 per 3+)</label>
                                <input type="number" id="balistic-0" name="balistic-0" min="2" max="6" required>
                            </div>
                            <div class="form-group">
                                <label for="sustainedHits-0">Sustained Hits X (0 per disabilitare)</label>
                                <input type="number" id="sustainedHits-0" name="sustainedHits-0" min="0" max="6" value="0" required>
                            </div>
                            <div class="form-group" style="margin-top:-0.7rem;">
                                <div class="checkbox-row">
                                    <input type="checkbox" id="rerollFail-0" name="rerollFail-0" class="styled-checkbox">
                                    <label for="rerollFail-0" class="styled-checkbox-label">Permetti reroll di tutti i tiri falliti</label>
                                </div>
                                <div class="checkbox-row">
                                    <input type="checkbox" id="reroll1-0" name="reroll1-0" class="styled-checkbox">
                                    <label for="reroll1-0" class="styled-checkbox-label">Permetti reroll dei risultati 1</label>
                                </div>
                    </div>
                            <div class="form-group">
                                <label for="forza-0">Forza</label>
                                <input type="number" id="forza-0" name="forza-0" min="1" max="999" required>
                            </div>
                            <div class="form-group" style="margin-top:-0.7rem;">
                                <div class="checkbox-row">
                                    <input type="checkbox" id="rerollWoundFail-0" name="rerollWoundFail-0" class="styled-checkbox">
                                    <label for="rerollWoundFail-0" class="styled-checkbox-label">Permetti reroll di tutti i tiri per ferire falliti</label>
                                </div>
                                <div class="checkbox-row">
                                    <input type="checkbox" id="rerollWound1-0" name="rerollWound1-0" class="styled-checkbox">
                                    <label for="rerollWound1-0" class="styled-checkbox-label">Permetti reroll dei risultati 1 per ferire</label>
                                </div>
                                <div class="checkbox-row">
                                    <input type="checkbox" id="lethalHits-0" name="lethalHits-0" class="styled-checkbox">
                                    <label for="lethalHits-0" class="styled-checkbox-label">Lethal Hits (6 per colpire feriscono automaticamente)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="penetrazione-0">Penetrazione armatura (AP)</label>
                                <input type="number" id="penetrazione-0" name="penetrazione-0" min="0" max="999" required>
                            </div>
                            <div class="form-group">
                                <label for="danni-0">Danni <span style="font-weight:normal;font-size:0.9em">(es: 2, 1-3, 1,2,3, D3)</span></label>
                                <input type="text" id="danni-0" name="danni-0" pattern="([0-9]+|[dD][0-9]+)([\-,+][0-9]+|[\-,+][dD][0-9]+|,[0-9]+|,[dD][0-9]+)*" maxlength="20" required placeholder="2, 1-3, D3, D6+2, 2+D3">
                            </div>
                        </div>
                    </div>
                    <button type="button" id="aggiungi-profilo" class="btn-secondary">+ Aggiungi profilo</button>
                </form>
            </section>
            <div class="divider"></div>
            <section class="col col-target">
                <h2>Bersaglio</h2>
                <div class="form-group">
                    <label for="resistenza">Resistenza avversario</label>
                    <input type="number" id="resistenza" name="resistenza" min="1" max="999" form="calcolatore-form" required>
                </div>
                <div class="form-group">
                    <label for="salvezza">Salvezza avversaria (es: 3 per 3+)</label>
                    <input type="number" id="salvezza" name="salvezza" min="2" max="7" form="calcolatore-form" required>
                </div>
                <div class="form-group">
                    <label for="ferite">Ferite del bersaglio</label>
                    <input type="number" id="ferite" name="ferite" min="1" max="999" form="calcolatore-form" required>
                </div>
                <div class="form-group">
                    <label for="modelli">Numero di modelli nell'unità</label>
                    <input type="number" id="modelli" name="modelli" min="1" max="999" form="calcolatore-form" required>
                </div>
            </section>
            <div class="divider"></div>
            <section class="col col-result">
                <h2>Risultato</h2>
                <button type="submit" form="calcolatore-form">Calcola</button>
                <div id="risultati-container">
                    <section id="risultati-separati"></section>
                    <section id="risultato-aggregato"></section>
                </div>
            </section>
        </div>
    </main>
        <script src="assets/app.js"></script>
    <script src="assets/nav.js"></script>
        <script>
            // Gestione della mutua esclusione tra le checkbox reroll per ogni profilo
            document.addEventListener('DOMContentLoaded', function() {
                function setupProfileCheckboxes(profiloId) {
                    var reroll1 = document.getElementById(`reroll1-${profiloId}`);
                    var rerollFail = document.getElementById(`rerollFail-${profiloId}`);
                    var rerollWound1 = document.getElementById(`rerollWound1-${profiloId}`);
                    var rerollWoundFail = document.getElementById(`rerollWoundFail-${profiloId}`);
                    
                    if (reroll1 && rerollFail) {
                        reroll1.addEventListener('change', function() {
                            if (reroll1.checked) rerollFail.checked = false;
                        });
                        
                        rerollFail.addEventListener('change', function() {
                            if (rerollFail.checked) reroll1.checked = false;
                        });
                    }
                    
                    if (rerollWound1 && rerollWoundFail) {
                        rerollWound1.addEventListener('change', function() {
                            if (rerollWound1.checked) rerollWoundFail.checked = false;
                        });
                        
                        rerollWoundFail.addEventListener('change', function() {
                            if (rerollWoundFail.checked) rerollWound1.checked = false;
                        });
                    }
                }
                
                // Setup per il primo profilo
                setupProfileCheckboxes(0);
                
                // Setup per il pulsante di aggiunta profilo
                var btnAggiungiProfilo = document.getElementById('aggiungi-profilo');
                if (btnAggiungiProfilo) {
                    btnAggiungiProfilo.addEventListener('click', function() {
                        // Il listener verrà aggiunto automaticamente alla nuova checkbox dal codice di creaNuovoProfilo
                    });
                }
            });
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    // Register service worker with absolute path so the SW scope matches manifest scope on GitHub Pages
                    var swPath = '/calcolatore_40k/service-worker.js';
                    navigator.serviceWorker.register(swPath).catch(function(err){
                        console.warn('SW registration failed:', err);
                    });
                });
            }
        </script>
</body>

</html>